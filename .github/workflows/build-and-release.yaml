name: Build and Release HellFire Windows

on:
  push:
    branches:
      - feat/add-build-action # TODO
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v147.0a1_FP1)'
        required: true
        type: string
  # schedule:
  #   # Check for new tags daily at 2 AM UTC
  #   - cron: '0 2 * * *'

env:
  FIREFOX_VERSION: '' # Will be set dynamically from tag

jobs:
  check-new-version:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch:
          - autoland
          - beta
          - release
        include:
          - branch: autoland
            release_name: -nightly
          - branch: beta
            release_name: -beta
          - branch: release
            release_name: ''
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      autoland-has-new-version: ${{ steps.set-output.outputs.autoland-has-new-version }}
      beta-has-new-version: ${{ steps.set-output.outputs.beta-has-new-version }}
      release-has-new-version: ${{ steps.set-output.outputs.release-has-new-version }}
    steps:
      - name: Get version for branch ${{ matrix.branch }}
        id: get-version
        run: |
          # Fetch version from Firefox repository
          LATEST_VERSION=$(curl -s https://github.com/mozilla-firefox/firefox/raw/refs/heads/${{ matrix.branch }}/browser/config/version.txt)

          # Check if we've already built this version
          EXISTING_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/${LATEST_VERSION}${{ matrix.release_name }}")

          if echo "$EXISTING_RELEASE" | jq -e .tag_name > /dev/null 2>&1; then
            echo "${{ matrix.branch }}-has-new-version=false" >> $GITHUB_OUTPUT
            echo "Tag ${LATEST_VERSION}${{ matrix.release_name }} already exists"
          else
            echo "version=${LATEST_VERSION}${{ matrix.release_name }}" >> $GITHUB_OUTPUT
            echo "${{ matrix.branch }}-has-new-version=true" >> $GITHUB_OUTPUT
            echo "New version found: ${LATEST_VERSION}${{ matrix.release_name }}"
          fi

  # Nightly
  build-autoland:
    needs: check-new-version
    if: needs.check-new-version.outputs.autoland-has-new-version == 'true'
    uses: ./.github/workflows/template-build.yaml
    with:
      branch: autoland

  release-autoland:
    needs: [check-new-version, build-autoland]
    if: needs.check-new-version.outputs.autoland-has-new-version == 'true'
    uses: ./.github/workflows/template-release.yaml
    with:
      branch: autoland
      version: needs.check-new-version.outputs.version
      artifact: needs.build-autoland.outputs.artifact

  # Beta
  build-beta:
    needs: check-new-version
    if: needs.check-new-version.outputs.beta-has-new-version == 'true'
    uses: ./.github/workflows/template-build.yaml
    with:
      branch: beta

  release-beta:
    needs: [check-new-version, build-beta]
    if: needs.check-new-version.outputs.beta-has-new-version == 'true'
    uses: ./.github/workflows/template-release.yaml
    with:
      branch: beta
      version: needs.check-new-version.outputs.version
      artifact: needs.build-beta.outputs.artifact

  # Stable
  build-release:
    needs: check-new-version
    if: needs.check-new-version.outputs.release-has-new-version == 'true'
    uses: ./.github/workflows/template-build.yaml
    with:
      branch: release

  release-release:
    needs: [check-new-version, build-release]
    if: needs.check-new-version.outputs.release-has-new-version == 'true'
    uses: ./.github/workflows/template-release.yaml
    with:
      branch: release
      version: needs.check-new-version.outputs.version
      artifact: needs.build-release.outputs.artifact
